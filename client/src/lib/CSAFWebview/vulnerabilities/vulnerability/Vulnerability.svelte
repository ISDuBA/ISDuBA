<!--
 This file is Free Software under the MIT License
 without warranty, see README.md and LICENSES/MIT.txt for details.

 SPDX-License-Identifier: Apache-2.0

 SPDX-FileCopyrightText: 2023 German Federal Office for Information Security (BSI) <https://www.bsi.bund.de>
 Software-Engineering: 2023 Intevation GmbH <https://intevation.de>
-->
<script lang="ts">
  import { appStore } from "$lib/store";
  import { tick } from "svelte";
  import Acknowledgments from "$lib/CSAFWebview/acknowledgments/Acknowledgments.svelte";
  import Collapsible from "$lib/CSAFWebview/Collapsible.svelte";
  import Flags from "./flags/Flags.svelte";
  import GeneralSection from "./GeneralSection.svelte";
  import ID from "./ID.svelte";
  import Involvements from "./involvements/Involvements.svelte";
  import Notes from "$lib/CSAFWebview/notes/Notes.svelte";
  import ProductStatus from "./productStatus/ProductStatus.svelte";
  import References from "../../references/References.svelte";
  import Remediations from "./remediations/Remediations.svelte";
  import Scores from "./scores/Scores.svelte";
  import Threats from "./threats/Threats.svelte";
  import type { Vulnerability } from "$lib/types";

  export let vulnerability: Vulnerability;
  export let index = 1;
  /**
   * updateUI waits until UI is settled and scrolls the vulnerability into view.
   */
  async function updateUI() {
    await tick();
    document.getElementById(`${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
  }
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;
  let open = false;
  $: if (
    $appStore.webview.doc?.vulnerabilities &&
    $appStore.webview.doc?.vulnerabilities.length === 1
  ) {
    open = true;
  }
  $: if (
    $appStore.webview.ui.selectedCVE &&
    $appStore.webview.ui.selectedCVE === vulnerability.cve
  ) {
    open = true;
    updateUI();
  } else if (
    $appStore.webview.ui.selectedCVE &&
    $appStore.webview.ui.selectedCVE !== vulnerability.cve
  ) {
    open = false;
  }
</script>

<div>
  <Collapsible
    {header}
    level="3"
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    <div>
      <GeneralSection {vulnerability} />
      {#if vulnerability.acknowledgments}
        <Collapsible header="Acknowledgments" level="4">
          <Acknowledgments acknowledegments={vulnerability.acknowledgments} />
        </Collapsible>
      {/if}
      {#if vulnerability.flags}
        <Flags {vulnerability} />
      {/if}
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <ID {vulnerability} />
      {/if}
      {#if vulnerability.involvements}
        <Involvements {vulnerability} />
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level="4" open={vulnerability.notes.length === 1}>
          <Notes notes={vulnerability.notes} />
        </Collapsible>
      {/if}
      {#if vulnerability.product_status}
        <ProductStatus {vulnerability} />
      {/if}
      {#if vulnerability.references}
        <Collapsible header="References" level="4">
          <References references={vulnerability.references} />
        </Collapsible>
      {/if}
      {#if vulnerability.remediations}
        <Remediations {vulnerability} />
      {/if}
      {#if vulnerability.scores}
        <Scores {vulnerability} />
      {/if}
      {#if vulnerability.threats}
        <Threats {vulnerability} />
      {/if}
    </div>
  </Collapsible>
</div>

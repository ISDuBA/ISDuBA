<!--
 This file is Free Software under the Apache-2.0 License
 without warranty, see README.md and LICENSES/Apache-2.0.txt for details.

 SPDX-License-Identifier: Apache-2.0

 SPDX-FileCopyrightText: 2023 German Federal Office for Information Security (BSI) <https://www.bsi.bund.de>
 Software-Engineering: 2023 Intevation GmbH <https://intevation.de>
-->
<script lang="ts">
  import { appStore } from "$lib/store";
  import { tick } from "svelte";
  import Acknowledgements from "$lib/Advisories/CSAFWebview/acknowledgements/Acknowledgements.svelte";
  import Collapsible from "$lib/Advisories/CSAFWebview/Collapsible.svelte";
  import Flags from "./flags/Flags.svelte";
  import GeneralSection from "./GeneralSection.svelte";
  import ID from "./ID.svelte";
  import Involvements from "./involvements/Involvements.svelte";
  import Notes from "$lib/Advisories/CSAFWebview/notes/Notes.svelte";
  import ProductStatus from "./productStatus/ProductStatus.svelte";
  import References from "../../references/References.svelte";
  import Remediations from "./remediations/Remediations.svelte";
  import Scores from "./scores/Scores.svelte";
  import Threats from "./threats/Threats.svelte";
  import type { Vulnerability } from "$lib/pmdTypes";
  import { cveCutoff } from "../../efficiencyCutoffs";

  export let basePath = "";
  export let vulnerability: Vulnerability;
  export let index = 1;
  let blink = false;
  /**
   * updateUI waits until UI is settled and scrolls the vulnerability into view.
   */
  async function updateUI() {
    await tick();
    document.getElementById(`${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
    blink = true;
    await new Promise((res) => setTimeout(res, 5000));
    blink = false;
  }
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;

  $: vulnerabilities = $appStore.webview.doc?.vulnerabilities;
  $: selectedCVE = $appStore.webview.ui.selectedCVE;
  $: currentCVE = vulnerability.cve;

  let open = false;
  $: if (vulnerabilities && vulnerabilities.length <= cveCutoff) {
    open = true;
  }
  $: if (selectedCVE && selectedCVE === currentCVE) {
    open = true;
    updateUI();
  } else if (selectedCVE && selectedCVE !== currentCVE) {
    open = vulnerabilities && vulnerabilities.length <= cveCutoff;
  }
</script>

<div class={blink ? "blink" : ""}>
  <Collapsible
    {header}
    level={3}
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    <div>
      <GeneralSection {vulnerability} />
      {#if vulnerability.Acknowledgements}
        <Collapsible header="Acknowledgements" level={4}>
          <Acknowledgements acknowledegements={vulnerability.Acknowledgements} />
        </Collapsible>
      {/if}
      {#if vulnerability.flags}
        <Flags {vulnerability} />
      {/if}
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <ID {vulnerability} />
      {/if}
      {#if vulnerability.involvements}
        <Involvements {vulnerability} />
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level={4} open>
          <Notes notes={vulnerability.notes} />
        </Collapsible>
      {/if}
      {#if vulnerability.product_status}
        <ProductStatus {vulnerability} {basePath} />
      {/if}
      {#if vulnerability.references}
        <Collapsible header="References" level={4}>
          <References references={vulnerability.references} />
        </Collapsible>
      {/if}
      {#if vulnerability.remediations}
        <Remediations {vulnerability} {basePath} />
      {/if}
      {#if vulnerability.scores}
        <Scores {vulnerability} />
      {/if}
      {#if vulnerability.threats}
        <Threats {vulnerability} />
      {/if}
    </div>
  </Collapsible>
</div>

<!--
 This file is Free Software under the Apache-2.0 License
 without warranty, see README.md and LICENSES/Apache-2.0.txt for details.

 SPDX-License-Identifier: Apache-2.0

 SPDX-FileCopyrightText: 2023 German Federal Office for Information Security (BSI) <https://www.bsi.bund.de>
 Software-Engineering: 2023 Intevation GmbH <https://intevation.de>
-->
<script lang="ts">
  import { appStore } from "$lib/store.svelte";
  import { getContext, tick, untrack } from "svelte";
  import Acknowledgments from "$lib/Advisories/CSAFWebview/acknowledgments/Acknowledgments.svelte";
  import Collapsible from "$lib/Advisories/CSAFWebview/Collapsible.svelte";
  import Flags from "./flags/Flags.svelte";
  import GeneralSection from "./GeneralSection.svelte";
  import ID from "./ID.svelte";
  import Involvements from "./involvements/Involvements.svelte";
  import Notes from "$lib/Advisories/CSAFWebview/notes/Notes.svelte";
  import ProductStatus from "./productStatus/ProductStatus.svelte";
  import References from "../../references/References.svelte";
  import Remediations from "./remediations/Remediations.svelte";
  import Scores from "./scores/Scores.svelte";
  import Threats from "./threats/Threats.svelte";
  import type { Vulnerability } from "$lib/pmdTypes";
  import { cveCutoff } from "../../efficiencyCutoffs";
  import CVSS from "$lib/Advisories/CSAFWebview/general/CVSS.svelte";
  import { compareScores } from "$lib/Advisories/CSAFWebview/vulnerabilities/vulnerability/scores/cvss";
  import { Button } from "flowbite-svelte";
  import { push } from "svelte-spa-router";

  interface Props {
    basePath: string;
    vulnerability: Vulnerability;
    index?: number;
  }

  let { basePath = "", vulnerability, index = 1 }: Props = $props();
  let blink = $state(false);
  /**
   * updateUI waits until UI is settled and scrolls the vulnerability into view.
   */
  async function updateUI() {
    await tick();
    document.getElementById(`${vulnerability.cve}`)?.scrollIntoView({ behavior: "smooth" });
    blink = true;
    await new Promise((res) => setTimeout(res, 5000));
    blink = false;
  }
  let header = vulnerability.cve ? vulnerability.cve : `Vulnerability ${index}`;

  let vulnerabilities = $derived(appStore.state.webview.doc?.vulnerabilities);
  let selectedCVE = $derived(appStore.state.webview.ui.selectedCVE);
  let currentCVE = $derived(vulnerability.cve);
  let highestScore: any = $derived.by(() => {
    if (vulnerability.scores) {
      const cvss3Scores = vulnerability.scores.filter((s) => s.cvss_v3).map((s) => s.cvss_v3);
      if (cvss3Scores?.length > 0) {
        return cvss3Scores.sort(compareScores)[0];
      }
      const cvss2Scores = vulnerability.scores.filter((s) => s.cvss_v2).map((s) => s.cvss_v2);
      if (cvss2Scores?.length > 0) {
        return cvss2Scores.sort(compareScores)[0];
      }
    }
  });

  let open = $derived.by(() => {
    if (vulnerabilities && vulnerabilities.length <= cveCutoff) {
      return true;
    }
    if (selectedCVE && selectedCVE === currentCVE) {
      return true;
    } else if (selectedCVE && selectedCVE !== currentCVE) {
      return vulnerabilities && vulnerabilities.length <= cveCutoff;
    }
    return false;
  });

  $effect(() => {
    untrack(() => blink);
    untrack(() => selectedCVE);
    if (selectedCVE && selectedCVE === currentCVE) {
      appStore.resetSelectedCVE();
      updateUI();
    }
  });

  const openRelatedDocuments = () => {
    push(`${basePath}${basePath.endsWith("/") ? "" : "/"}related/documents/${currentCVE}`);
  };

  const relatedDocuments: any = getContext("advisory");
</script>

<div class={blink ? "blink mb-1" : "mb-1"}>
  <Collapsible
    {header}
    level={3}
    {open}
    onClose={() => {
      appStore.resetSelectedCVE();
    }}
  >
    {#snippet headerRightSlot()}
      <div class="flex gap-2">
        <CVSS baseSeverity={highestScore?.baseSeverity} baseScore={highestScore?.baseScore}></CVSS>
        {#if relatedDocuments?.()}
          {@const len = Object.values(relatedDocuments()).filter((d: any) => {
            return d.cve.includes(currentCVE);
          }).length}
          {#if len > 0}
            <Button onclick={openRelatedDocuments} color="light" size="xs" class="h-7">
              <div class="flex items-center gap-1">
                <i class="bx bx-link-alt"></i>
                {len}
              </div>
            </Button>
          {/if}
        {/if}
      </div>
    {/snippet}
    <div>
      <GeneralSection {vulnerability} />
      {#if vulnerability.Acknowledgments}
        <Collapsible header="Acknowledgments" level={4}>
          <Acknowledgments acknowledgments={vulnerability.Acknowledgments} />
        </Collapsible>
      {/if}
      {#if vulnerability.flags}
        <Flags {vulnerability} />
      {/if}
      {#if vulnerability.ids && Array.isArray(vulnerability.ids)}
        <ID {vulnerability} />
      {/if}
      {#if vulnerability.involvements}
        <Involvements {vulnerability} />
      {/if}
      {#if vulnerability.notes && Array.isArray(vulnerability.notes)}
        <Collapsible header="Notes" level={4} open>
          <Notes notes={vulnerability.notes} />
        </Collapsible>
      {/if}
      {#if vulnerability.product_status}
        <ProductStatus {vulnerability} {basePath} />
      {/if}
      {#if vulnerability.references}
        <Collapsible header="References" level={4}>
          <References references={vulnerability.references} />
        </Collapsible>
      {/if}
      {#if vulnerability.remediations}
        <Remediations {vulnerability} {basePath} />
      {/if}
      {#if vulnerability.scores}
        <Scores {vulnerability} {basePath} />
      {/if}
      {#if vulnerability.threats}
        <Threats {vulnerability} />
      {/if}
    </div>
  </Collapsible>
</div>
